/**
 * Class Geolocation Core
 *
 * Provide methods for Geolocation.
 * 
 * @copyright  MEN AT WORK 2012
 * @package    geolocation
 */
var Geolocation=new Class({Implements:[Options],options:{debug:false,session:"",requesttoken:""},infoElements:[],vars:{lat:0,lon:0,mode:-1},initialize:function(a){this.setOptions(a)},setDebug:function(a){this.options.debug=a},addInfoElement:function(a){if(!this.infoElements[a]){this.infoElements[a]=[]}this.infoElements.include(a)},runGeolocation:function(){this.onProgress();if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(a){this.vars.lat=a.coords.latitude;this.vars.lon=a.coords.longitude;this.updatePosition()}.bind(this),function(a){this.updateError(a.code)}.bind(this))}else{if(this.options.debug==true){console.log("Geolocation is not supported by this browser")}this.updateError(10)}},updatePosition:function(){if(this.options.debug==true){console.log("Start location updating");console.log(this.vars)}if(this.options.requesttoken!=""){data={action:"GeoSetLocation",session:this.options.session,lat:this.vars.lat,lon:this.vars.lon,isAJAX:true,REQUEST_TOKEN:this.options.requesttoken}}else{data={action:"GeoSetLocation",session:this.options.session,lat:this.vars.lat,lon:this.vars.lon,isAJAX:true}}if(this.options.debug==true){console.log("Start Request");console.log(this.vars)}new Request.JSON({method:"post",url:"ajax.php",data:data,evalScripts:false,evalResponse:false,onSuccess:function(b,a){if(this.options.debug==true){console.log("On Success");console.log(this.vars)}if(this.options.requesttoken!=""){this.options.requesttoken=b.token}if(b.content.success==true){this.onSuccess()}else{if(this.options.debug==true){console.log("Error by server");console.log(a)}}}.bind(this),onError:function(b,a){if(this.options.debug==true){console.log("Error by Json Request");console.log(a)}this.onFailure(20)}.bind(this),onFailure:function(b,a){if(this.options.debug==true){console.log("Error by Json Request");console.log(a)}this.onFailure(20)}.bind(this)}).send()},updateError:function(a){if(this.options.debug==true){console.log("Start error updating");console.log(a)}if(this.options.requesttoken!=""){data={action:"GeoSetError",session:this.options.session,errID:a,isAJAX:true,REQUEST_TOKEN:this.options.requesttoken}}else{data={action:"GeoSetError",session:this.options.session,errID:a,isAJAX:true}}new Request.JSON({method:"post",url:"ajax.php",data:data,evalScripts:false,evalResponse:false,onSuccess:function(c,b){if(this.options.requesttoken!=""){this.options.requesttoken=c.token}if(this.options.debug==true){console.log("Success");console.log(b)}this.onFailure(a)}.bind(this),onError:function(c,b){if(this.options.debug==true){console.log("Error by Json Request");console.log(b)}this.onFailure(20)}.bind(this),onFailure:function(c,b){if(this.options.debug==true){console.log("Error by Json Request");console.log(b)}this.onFailure(20)}.bind(this)}).send()},updateInfoElements:function(a){this.infoElements.each(function(b){$(b).set("html",a)})},onProgress:function(){this.updateInfoElements(this.options.messages.sart)},afterProgress:function(){this.updateInfoElements(this.options.messages.finished)},onSuccess:function(){window.location.reload()},onFailure:function(a){switch(a){case 1:this.updateInfoElements(this.options.messages.permissionDenied);window.location.reload();break;case 2:this.updateInfoElements(this.options.messages.positionUnavailable);window.location.reload();break;case 3:this.updateInfoElements(this.options.messages.timeOut);window.location.reload();break;case 10:this.updateInfoElements(this.options.messages.unsupportedBrowser);window.location.reload();break;case 20:this.updateInfoElements(this.options.messages.noConnection);break;default:this.updateInfoElements(this.options.messages.unknownError);break}}});